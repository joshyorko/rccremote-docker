<% content_for :title, "Catalogs | Rails RCC Remote" %>

<section class="panel"
         data-controller="catalog-rebuild"
         data-catalog-rebuild-refresh-url-value="<%= catalogs_path %>">
  <div class="panel-header">
    <div>
      <h1 class="panel-title">Holotree catalogs</h1>
      <p class="panel-meta">Catalog count: <%= @catalogs.length %></p>
      <p class="panel-meta">
        Snapshot source: <%= @catalog_snapshot_source.to_s.upcase %>
        <% if @catalog_snapshot_at.present? %>
          | Updated <%= formatted_status_timestamp(@catalog_snapshot_at) %>
        <% end %>
      </p>
    </div>

    <%= form_with url: rebuild_catalogs_path,
                  method: :post,
                  class: "inline-form",
                  data: {
                    catalog_rebuild_target: "form",
                    action: "submit->catalog-rebuild#start"
                  } do %>
      <%= button_tag "Rebuild catalogs",
                     type: "submit",
                     class: "button button-primary",
                     data: { catalog_rebuild_target: "submit" } %>
    <% end %>
  </div>

  <% if @catalog_error.present? %>
    <p class="empty error-text"><%= @catalog_error %></p>
  <% end %>

  <div class="rebuild-progress" data-catalog-rebuild-target="progress" hidden>
    <div class="rebuild-progress__header">
      <p class="rebuild-progress__title">Catalog rebuild progress</p>
      <span class="rebuild-progress__percent" data-catalog-rebuild-target="percent">0%</span>
    </div>

    <div class="rebuild-progress__bar">
      <div class="rebuild-progress__fill" data-catalog-rebuild-target="bar"></div>
    </div>

    <p class="rebuild-progress__status" data-catalog-rebuild-target="status" aria-live="polite">Ready to rebuild.</p>
    <div class="rebuild-progress__log" data-catalog-rebuild-target="log" role="log" aria-live="polite"></div>
  </div>
</section>

<section class="panel">
  <h2 class="panel-title">Latest holotree catalog snapshot</h2>

  <% if @catalogs.empty? %>
    <p class="empty">No catalogs found. Create robots or upload ZIP files first.</p>
  <% else %>
    <div class="table-wrap">
      <table class="table catalog-snapshot-table">
        <thead>
          <tr>
            <th>Blueprint</th>
            <th>Platform</th>
            <th>Size</th>
            <th>Files</th>
            <th>Dirs</th>
            <th>Relocations</th>
            <th>Age</th>
            <th>Idle</th>
            <th>Identity</th>
            <th>Holotree path</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <%= render partial: "catalog_row", collection: @catalogs, as: :catalog %>
        </tbody>
      </table>
    </div>
  <% end %>
</section>
