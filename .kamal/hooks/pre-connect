#!/usr/bin/env bash
set -euo pipefail

resolve_ssh_user() {
  ruby <<'RUBY'
require "yaml"

destination = ENV["KAMAL_DESTINATION"].to_s
config_path = destination.empty? ? "config/deploy.yml" : "config/deploy.#{destination}.yml"

if File.exist?(config_path)
  config = YAML.load_file(config_path) || {}
  user = config.dig("ssh", "user").to_s
  puts user unless user.empty?
end
RUBY
}

SSH_USER="${KAMAL_SSH_USER:-$(resolve_ssh_user)}"
SSH_USER="${SSH_USER:-$USER}"
HOSTS="${KAMAL_HOSTS:-}"

if [[ -z "$HOSTS" ]]; then
  exit 0
fi

IFS=',' read -r -a HOST_ARRAY <<< "$HOSTS"

for host in "${HOST_ARRAY[@]}"; do
  host="$(echo "$host" | xargs)"
  [[ -z "$host" ]] && continue

  echo "pre-connect: checking SSH for ${SSH_USER}@${host}"
  ssh -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "${SSH_USER}@${host}" "echo ok >/dev/null"
done
