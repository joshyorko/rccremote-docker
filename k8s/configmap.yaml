apiVersion: v1
kind: ConfigMap
metadata:
  name: rccremote-config
  namespace: rccremote
data:
  SERVER_NAME: "rccremote.local"
  ROBOCORP_HOME: "/opt/robocorp"
  HOLOLIB_ZIP_PATH: "/hololib_zip"
  HOLOLIB_ZIP_PATH_INT: "/hololib_zip_internal"
  ROBOTS_PATH: "/robots"
  # RCC Remote configuration
  RCCREMOTE_HOSTNAME: "0.0.0.0"
  RCCREMOTE_PORT: "4653"
  # Nginx configuration
  NGINX_UPSTREAM: "rccremote:4653"
  NGINX_PORT: "443"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rccremote-nginx-config
  namespace: rccremote
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      upstream rccremote {
        server localhost:4653;
      }

      server {
        listen 443 ssl;
        server_name rccremote.local;

        ssl_certificate /etc/nginx/certs/tls.crt;
        ssl_certificate_key /etc/nginx/certs/tls.key;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';

        # Health check endpoints
        location /health/live {
          proxy_pass http://rccremote/health/live;
          proxy_set_header Host $host;
          access_log off;
        }

        location /health/ready {
          proxy_pass http://rccremote/health/ready;
          proxy_set_header Host $host;
          access_log off;
        }

        location /health/startup {
          proxy_pass http://rccremote/health/startup;
          proxy_set_header Host $host;
          access_log off;
        }

        # Main proxy
        location / {
          proxy_pass http://rccremote;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          
          # Increase timeouts for large catalog transfers
          proxy_connect_timeout 60s;
          proxy_send_timeout 300s;
          proxy_read_timeout 300s;
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rccremote-scripts
  namespace: rccremote
data:
  entrypoint-rcc.sh: |
    #!/bin/sh
    set -e
    
    # Simplified entrypoint for Kubernetes
    HOLOLIB_ZIP_PATH_INT=/hololib_zip_internal
    HOLOLIB_ZIP_PATH=/hololib_zip
    ROBOTS_PATH=/robots

    disable_rcc_telemetry() {
        echo "Disabling RCC telemetry..."
        rcc config identity -t
    }

    build_and_export_catalogs() {
        echo "=== Building catalogs from robot directories..."
        
        if [ ! -d "$ROBOTS_PATH" ] || [ -z "$(ls -A $ROBOTS_PATH 2>/dev/null)" ]; then
            echo "No robot directories found in $ROBOTS_PATH, skipping catalog build."
            return
        fi

        for robot_dir in "$ROBOTS_PATH"/*; do
            if [ -d "$robot_dir" ] && [ -f "$robot_dir/robot.yaml" ] && [ -f "$robot_dir/conda.yaml" ]; then
                robot_name=$(basename "$robot_dir")
                echo "Building catalog for: $robot_name"
                
                # Source .env if exists
                if [ -f "$robot_dir/.env" ]; then
                    echo "Sourcing $robot_dir/.env"
                    set -a
                    . "$robot_dir/.env"
                    set +a
                fi
                
                # Build and export
                cd "$robot_dir"
                rcc holotree variables --robot robot.yaml --controller rccremote
                rcc holotree export --robot robot.yaml --zipfile "$HOLOLIB_ZIP_PATH_INT/${robot_name}.zip"
                echo "âœ“ Exported catalog: ${robot_name}.zip"
            fi
        done
    }

    import_catalogs() {
        echo "=== Importing catalogs..."
        
        # Import internal ZIPs
        if [ -d "$HOLOLIB_ZIP_PATH_INT" ]; then
            for zip_file in "$HOLOLIB_ZIP_PATH_INT"/*.zip; do
                if [ -f "$zip_file" ]; then
                    echo "Importing: $(basename $zip_file)"
                    rcc holotree import --zipfile "$zip_file"
                fi
            done
        fi
        
        # Import external ZIPs
        if [ -d "$HOLOLIB_ZIP_PATH" ]; then
            for zip_file in "$HOLOLIB_ZIP_PATH"/*.zip; do
                if [ -f "$zip_file" ]; then
                    echo "Importing: $(basename $zip_file)"
                    rcc holotree import --zipfile "$zip_file"
                fi
            done
        fi
    }

    start_rccremote() {
        echo "=== Starting RCC Remote Server ==="
        
        disable_rcc_telemetry
        
        # Initialize holotree
        echo "Initializing holotree..."
        rcc holotree shared --enable
        rcc holotree init
        
        # Build and import catalogs
        build_and_export_catalogs
        import_catalogs
        
        # List available catalogs
        echo "=== Available catalogs ==="
        rcc holotree catalogs
        
        # Start rccremote server
        echo "Starting rccremote server on 0.0.0.0:4653..."
        exec rccremote --hostname 0.0.0.0 --port 4653
    }

    # Main
    if [ "$1" = "rccremote" ]; then
        start_rccremote
    else
        echo "Invalid mode. Use 'rccremote'"
        exit 1
    fi

