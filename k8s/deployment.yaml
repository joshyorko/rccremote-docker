apiVersion: apps/v1
kind: Deployment
metadata:
  name: rccremote
  namespace: rccremote
  labels:
    app: rccremote
spec:
  replicas: 1  # Set to 1 for local-path storage (ReadWriteOnce)
  strategy:
    type: Recreate  # Use Recreate strategy for RWO volumes
  selector:
    matchLabels:
      app: rccremote
  template:
    metadata:
      labels:
        app: rccremote
    spec:
      serviceAccountName: rccremote
      securityContext:
        fsGroup: 1000
      initContainers:
      - name: cert-init
        image: nicolaka/netshoot:latest
        command:
        - sh
        - -c
        - |
          # Check if certs exist and are not empty
          if [ ! -s /etc/certs/tls.crt ] || [ ! -s /etc/certs/tls.key ]; then
            echo "Certificates not found or empty. Generating self-signed certificates..."
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout /etc/certs/tls.key \
              -out /etc/certs/tls.crt \
              -subj "/CN=${SERVER_NAME}/O=RCCRemote/C=US" \
              -addext "subjectAltName=DNS:${SERVER_NAME},DNS:*.${SERVER_NAME},DNS:localhost"
            cp /etc/certs/tls.crt /etc/certs/rootCA.pem
            # Set permissive permissions so nginx container can read them
            chmod 644 /etc/certs/tls.crt /etc/certs/rootCA.pem /etc/certs/tls.key
            echo "Self-signed certificates generated successfully"
          else
            echo "Valid certificates found, skipping generation"
          fi
        envFrom:
        - configMapRef:
            name: rccremote-config
        volumeMounts:
        - name: certs
          mountPath: /etc/certs
      containers:
      - name: rccremote
        image: ghcr.io/yorko-io/rccremote-docker:latest
        imagePullPolicy: Always
        command: ["/scripts/entrypoint-rcc.sh"]
        args: ["rccremote"]
        ports:
        - containerPort: 4653
          name: rccremote
          protocol: TCP
        envFrom:
        - configMapRef:
            name: rccremote-config
        volumeMounts:
        - name: holotree-data
          mountPath: /opt/robocorp
        - name: hololib-zip
          mountPath: /hololib_zip
        - name: hololib-zip-internal
          mountPath: /hololib_zip_internal
        - name: robots
          mountPath: /robots
        - name: certs
          mountPath: /etc/certs
        - name: scripts
          mountPath: /scripts
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health/live
            port: 4653
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 4653
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /health/startup
            port: 4653
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
      - name: nginx
        image: nginx:alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 443
          name: https
          protocol: TCP
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: certs
          mountPath: /etc/nginx/certs
          readOnly: true
        - name: nginx-cache
          mountPath: /var/cache/nginx
        - name: nginx-run
          mountPath: /var/run
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health/live
            port: 443
            scheme: HTTPS
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 443
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 101
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
      volumes:
      - name: holotree-data
        persistentVolumeClaim:
          claimName: rccremote-holotree-pvc
      - name: hololib-zip
        persistentVolumeClaim:
          claimName: rccremote-hololib-pvc
      - name: hololib-zip-internal
        emptyDir: {}
      - name: robots
        configMap:
          name: rccremote-robots
          optional: true
      - name: certs
        emptyDir: {}
      - name: nginx-cache
        emptyDir: {}
      - name: nginx-run
        emptyDir: {}
      - name: scripts
        configMap:
          name: rccremote-scripts
          defaultMode: 0755
      - name: nginx-config
        configMap:
          name: rccremote-nginx-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rccremote
  namespace: rccremote
# HPA disabled for local-path storage (ReadWriteOnce requires single replica)
# ---
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: rccremote-hpa
#   namespace: rccremote
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: rccremote
#   minReplicas: 3
#   maxReplicas: 10
#   metrics:
#   - type: Resource
#     resource:
#       name: cpu
#       target:
#         type: Utilization
#         averageUtilization: 70
#   - type: Resource
#     resource:
#       name: memory
#       target:
#         type: Utilization
#         averageUtilization: 80
#   behavior:
#     scaleDown:
#       stabilizationWindowSeconds: 300
#       policies:
#       - type: Percent
#         value: 50
#         periodSeconds: 15
#     scaleUp:
#       stabilizationWindowSeconds: 0
#       policies:
#       - type: Percent
#         value: 100
#         periodSeconds: 15
#       - type: Pods
#         value: 2
#         periodSeconds: 15
#       selectPolicy: Max
