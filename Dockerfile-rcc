# Stage 1: Download binaries
FROM alpine:latest AS downloader
RUN apk add --no-cache wget ca-certificates
WORKDIR /tmp
ARG RCC_VERSION=v18.17.1
RUN wget https://github.com/joshyorko/rcc/releases/download/${RCC_VERSION}/rcc-linux64 -O rcc && \
    wget https://github.com/joshyorko/rcc/releases/download/${RCC_VERSION}/rccremote-linux64 -O rccremote && \
    chmod +x rcc rccremote

# Stage 2: Minimal Ubuntu runtime (glibc-based for RCC/micromamba compatibility)
FROM ubuntu:22.04

ENV LANG=C.UTF-8 LANGUAGE=C.UTF-8 LC_ALL=C.UTF-8 DEBIAN_FRONTEND=noninteractive

# Install only essential runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    gettext-base \
    bash \
    wget \
    && rm -rf /var/lib/apt/lists/*
    # Browser/playwright dependencies (if needed - Alpine has minimal versions)
    # libx11 \
    # libxcb \
    # libxext \
    # libxrandr \
    # libxcomposite \
    # libxcursor \
    # libxdamage \
    # libxfixes \
    # libxi \
    # gtk+3.0 \
    # pango \
    # cairo \
    # gdk-pixbuf \
    # glib \
    # alsa-lib \
    # freetype \
    # fontconfig \
    # dbus-libs \
    # nss \
    # nspr \
    # mesa-gbm

# Copy binaries from downloader stage
COPY --from=downloader /tmp/rcc /tmp/rccremote /usr/bin/
# Copy helper scripts into the image so the image is runnable without host mounts.
# This makes the image self-contained for production deployments.
COPY scripts /scripts
RUN chmod +x /scripts/*.sh || true

ENTRYPOINT [ "/scripts/entrypoint-rcc.sh" ]
