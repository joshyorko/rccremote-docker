version: '3.8'

# RCC Remote with Cloudflare Tunnel
# No SSL certificate management needed - Cloudflare handles it all!
# 
# Setup:
# 1. Create a Cloudflare Tunnel at https://one.dash.cloudflare.com/
# 2. Point it to http://rccremote:4653
# 3. Get your tunnel token
# 4. Set CF_TUNNEL_TOKEN in .env file or export it
# 5. docker compose -f examples/docker-compose.cloudflare.yml up -d
#
# Benefits:
# - Trusted SSL certificate (no custom RCC profile needed!)
# - Access from anywhere
# - Built-in DDoS protection and WAF
# - Zero SSL certificate management

services:
  rccremote:
    build:
      context: ..
      dockerfile: Dockerfile-rcc
    container_name: rccremote-cf
    hostname: rccremote
    command: ["rccremote"]
    environment:
      - SERVER_NAME=${SERVER_NAME:-rccremote.joshyorko.com}
      - ROBOCORP_HOME=/opt/robocorp
      - RCC_REMOTE_ORIGIN=https://${SERVER_NAME:-rccremote.joshyorko.com}
    volumes:
      - ../data/robots:/robots:ro
      - ../data/hololib_zip:/hololib_zip:ro
      - hololib_zip_internal:/hololib_zip_internal
      - robocorp_data:/opt/robocorp
      - ../scripts:/scripts:ro
    networks:
      - rccremote-network
    healthcheck:
      test: ["CMD", "pgrep", "-x", "rccremote"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: rccremote-cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    depends_on:
      rccremote:
        condition: service_healthy
    networks:
      - rccremote-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "cloudflared"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  rccremote-network:
    driver: bridge

volumes:
  hololib_zip_internal:
    driver: local
  robocorp_data:
    driver: local
